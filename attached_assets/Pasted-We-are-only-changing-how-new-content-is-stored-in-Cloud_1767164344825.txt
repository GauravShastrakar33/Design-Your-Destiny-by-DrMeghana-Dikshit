We are only changing how new content is stored in Cloudflare R2 going forward.

Do NOT perform any migration.
I have already manually deleted all old courses from the app and all thumbnails and lesson files from Cloudflare R2.

â— ABSOLUTE CONSTRAINTS (DO NOT VIOLATE)

âŒ NO database table changes

âŒ NO altering existing tables or columns

âŒ NO new tables

âŒ NO migrations

âŒ NO backward compatibility logic

âŒ NO reading or mapping old paths

âŒ NO data transformation

âœ… ONLY update upload paths for new content

If the current database already stores paths/URLs, reuse those fields as-is and only change the value written.

ğŸ¯ Objective

Update the app so that all newly uploaded course and lesson media is stored using the following fixed hierarchy in Cloudflare R2.

âœ… FINAL STORAGE HIERARCHY (AUTHORITATIVE)
programs/
â””â”€â”€ {PROGRAM_CODE}/
    â””â”€â”€ courses/
        â””â”€â”€ {courseId}/
            â”œâ”€â”€ thumbnail/
            â”‚   â””â”€â”€ course.png
            â”‚
            â””â”€â”€ modules/
                â””â”€â”€ {moduleId}/
                    â””â”€â”€ lessons/
                        â””â”€â”€ {lessonId}/
                            â”œâ”€â”€ video/
                            â”‚   â””â”€â”€ lesson.mp4
                            â”œâ”€â”€ audio/
                            â”‚   â””â”€â”€ lesson.mp3
                            â””â”€â”€ script/
                                â””â”€â”€ lesson.pdf

ğŸ”‘ Identifier Rules

PROGRAM_CODE

Uppercase (e.g. DYD, USB, USC, USM)

Immutable

Unique

courseId, moduleId, lessonId

Use existing DB IDs

Do not replace with names or slugs

ğŸ§© Admin Panel â†’ Storage Mapping
1ï¸âƒ£ Course Creation

Program is selected during course creation

Use programCode (not programId) as the root directory

2ï¸âƒ£ Course Thumbnail Upload

Store at:

programs/${programCode}/courses/${courseId}/thumbnail/course.png

3ï¸âƒ£ Module Creation

No files uploaded

Only existing DB records are created/used

R2 directories are implicit (created on first upload)

4ï¸âƒ£ Lesson Creation

No upload yet

Only metadata saved using existing tables

5ï¸âƒ£ Lesson File Uploads
Video
programs/${programCode}/courses/${courseId}/modules/${moduleId}/lessons/${lessonId}/video/lesson.mp4

Audio
programs/${programCode}/courses/${courseId}/modules/${moduleId}/lessons/${lessonId}/audio/lesson.mp3

Script (PDF)
programs/${programCode}/courses/${courseId}/modules/${moduleId}/lessons/${lessonId}/script/lesson.pdf

ğŸ› ï¸ Implementation Notes

Filenames must be fixed (course.png, lesson.mp4, etc.)

Do not generate random filenames

Cloudflare R2 folders are implicit

Use existing DB fields to store the new relative path or URL

Do not add new DB fields

Example stored value:

"videoPath": "programs/DYD/courses/11/modules/3/lessons/7/video/lesson.mp4"

ğŸš« Explicitly Do NOT Do

âŒ Do not modify database schema

âŒ Do not write migrations

âŒ Do not add fallback logic for old paths

âŒ Do not auto-create programs or change program codes

âŒ Do not clean up or scan old directories

âœ… Expected Result

All new uploads follow the program-first hierarchy

Database remains unchanged

Storage structure matches business logic exactly

Old CMS content is intentionally ignored
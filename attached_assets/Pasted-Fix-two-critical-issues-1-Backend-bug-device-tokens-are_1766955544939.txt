Fix two critical issues:

1ï¸âƒ£ Backend bug: device tokens are saved with user_id = null
2ï¸âƒ£ Frontend bug: notification toggle shows enabled based on browser permission instead of DB state

Do not change notification architecture.
Do not touch browser permission behavior.

ğŸ”§ FIX 1 â€” Backend: Correct User ID + Defensive Guard
Problem

The backend is reading req.user.id, but JWT payload uses req.user.sub.

Required Fix (MANDATORY)

In all notification routes, replace:

const userId = req.user.id;


with:

const userId = req.user.sub;

Add defensive guard (recommended)

Immediately after reading userId:

if (!userId) {
  return res.status(401).json({ error: "Unauthorized" });
}


This must be applied to:

POST /api/v1/notifications/register-device

DELETE /api/v1/notifications/unregister-device

Any future notification-related route

ğŸ”§ FIX 2 â€” Backend: Notification Status Endpoint (Source of Truth)
Add a new endpoint
GET /api/v1/notifications/status

Behavior

Uses JWT auth

Reads from device_tokens

Returns whether the current user has at least one registered device

Implementation
app.get(
  "/api/v1/notifications/status",
  authenticateJWT,
  async (req, res) => {
    const userId = req.user.sub;

    if (!userId) {
      return res.status(401).json({ error: "Unauthorized" });
    }

    const tokens = await db
      .select()
      .from(deviceTokens)
      .where(eq(deviceTokens.userId, userId))
      .limit(1);

    res.json({ enabled: tokens.length > 0 });
  }
);

ğŸ¨ FIX 3 â€” Frontend: Correct Notification Toggle Logic
Problem

UI currently uses:

Notification.permission === "granted"


This is browser-level, not user-level.

Correct Behavior (MANDATORY)

The toggle must reflect DB state, not browser permission.

Frontend Changes
1ï¸âƒ£ Fetch notification status on Profile load
GET /api/v1/notifications/status


Response:

{ "enabled": true | false }


Use this value to control the toggle state.

2ï¸âƒ£ Toggle behavior
Action	What to do
Enable	Request browser permission â†’ get FCM token â†’ call /register-device
Disable	Call /unregister-device only

ğŸš« Do NOT revoke browser permission
ğŸš« Do NOT use Notification.permission for UI state

3ï¸âƒ£ UI rule (important)
toggle.checked = backendStatus.enabled


This ensures:

Correct behavior across users

Correct behavior across browsers

Works later for Android & iOS

ğŸ§ª ACCEPTANCE CRITERIA

After this fix:

âœ… device_tokens.user_id is never null

âœ… Tokens are saved correctly after enabling notifications

âœ… Toggle shows OFF for users with no tokens

âœ… Toggle shows ON only when DB has tokens

âœ… Logging out + logging in as another user does NOT leak state

âœ… Browser permission behavior is untouched

ğŸš« DO NOT DO

âŒ Do not store notification state in localStorage

âŒ Do not auto-enable toggle based on browser permission

âŒ Do not attempt to revoke browser permissions

âŒ Do not add Android/iOS logic yet

ğŸ§  RESULT AFTER THIS PROMPT

You will have:

âœ… Correct token registration

âœ… Correct per-user notification state

âœ… Clean foundation for Phase 2 (Android + iOS FCM)

âœ… No future refactor needed
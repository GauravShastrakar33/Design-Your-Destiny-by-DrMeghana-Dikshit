Build Web Push Notifications (FCM + VAPID)
Context
* React (Vite) frontend
* Node.js + Express backend
* JWT auth exists (req.user.id)
* Firebase project already created
* Web App registered in Firebase
* VAPID key already generated
* Admin panel exists (web-only)
* Capacitor exists but native push NOT required yet
IMPORTANT
* This phase is WEB PUSH ONLY
* Must work for:
    * PWA
    * Desktop Chrome
    * Mobile Chrome (installed PWA)
* Do NOT add Android/iOS native push yet
* Do NOT break future Capacitor integration

üéØ GOAL (PHASE 1 ONLY)
Implement Web Push Notifications using Firebase Cloud Messaging (FCM + VAPID) with:
1. Frontend Firebase SDK setup
2. Service Worker for background notifications
3. Backend token storage
4. Backend notification sender
5. One test notification endpoint

üß± DATABASE
Create table:
device_tokens

id SERIAL PRIMARY KEY
user_id INT NOT NULL
token TEXT UNIQUE NOT NULL
platform TEXT CHECK (platform IN ('web')) NOT NULL
created_at TIMESTAMP DEFAULT NOW()
Rules:
* One user can have multiple tokens (multiple browsers/devices)
* Token must be UNIQUE

üñ•Ô∏è FRONTEND (React)
1Ô∏è‚É£ Install Firebase

npm install firebase

2Ô∏è‚É£ Firebase config
Create file:

client/src/lib/firebase.ts

import { initializeApp } from "firebase/app";
import { getMessaging, isSupported } from "firebase/messaging";

const firebaseConfig = {
 apiKey: "AIzaSyAJLuqn-Okx9JOFFKvJ0ctlaERe0I3rzdQ",
¬† authDomain: "dyd-by-dr-m.firebaseapp.com",
¬† projectId: "dyd-by-dr-m",
 storageBucket: "dyd-by-dr-m.firebasestorage.app",
¬† messagingSenderId: "645018757980",
¬† appId: "1:645018757980:web:fa4be9ab701ff87f0fef99",
¬† measurementId: "G-7X50EFX2SF"
};

export const firebaseApp = initializeApp(firebaseConfig);

export async function getFirebaseMessaging() {
  const supported = await isSupported();
  return supported ? getMessaging(firebaseApp) : null;
}
‚ö†Ô∏è Do NOT use service account keys in frontend.

3Ô∏è‚É£ Service Worker (MANDATORY)
Create:

client/public/firebase-messaging-sw.js

importScripts("https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js");
importScripts("https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging-compat.js");

firebase.initializeApp({
  apiKey: "AIzaSyAJLuqn-Okx9JOFFKvJ0ctlaERe0I3rzdQ",
¬† authDomain: "dyd-by-dr-m.firebaseapp.com",
¬† projectId: "dyd-by-dr-m",
 storageBucket: "dyd-by-dr-m.firebasestorage.app",
¬† messagingSenderId: "645018757980",
¬† appId: "1:645018757980:web:fa4be9ab701ff87f0fef99",
¬† measurementId: "G-7X50EFX2SF"
});

const messaging = firebase.messaging();

messaging.onBackgroundMessage((payload) => {
  self.registration.showNotification(
    payload.notification?.title || "Notification",
    {
      body: payload.notification?.body,
      icon: "/icon-192.png",
    }
  );
});

‚ÄúEnsure firebase-messaging-sw.js is served from the site root (/firebase-messaging-sw.js).‚Äù

4Ô∏è‚É£ Request permission + get token
Create helper:

import { getToken } from "firebase/messaging";
import { getFirebaseMessaging } from "@/lib/firebase";

export async function requestNotificationPermission() {
  if (!("Notification" in window)) return null;

  const permission = await Notification.requestPermission();
  if (permission !== "granted") return null;

  const messaging = await getFirebaseMessaging();
  if (!messaging) return null;

  const token = await getToken(messaging, {
    vapidKey: "BMrLLVU6E1DhWCD8jqgFWyamRpSOXMMbtBgbXxa4qVqMO_sctWDVASLKOLJv_zXi3MzTslf2Mg9TfIVYKWDjrNI",
  });

  return token;
}
Call this:
* After login
* Or on first app open

üîå BACKEND (Node + Express)
5Ô∏è‚É£ Save token API

POST /api/v1/notifications/register-device
Body: { token }
Behavior:
* Use req.user.id
* Upsert token
* platform = 'web'
* If the same token already exists (regardless of user), do nothing

6Ô∏è‚É£ Firebase Admin setup
Install:

npm install firebase-admin
Create:

server/lib/firebaseAdmin.ts

import admin from "firebase-admin";

admin.initializeApp({
  credential: admin.credential.cert(
    JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT!)
  ),
});

export const fcm = admin.messaging();
‚ö†Ô∏è Store service account JSON in env, NOT in repo.

7Ô∏è‚É£ Test notification endpoint (for now)

POST /admin/v1/notifications/test
Body: { title, body }
Behavior:
* Fetch all device_tokens
* Send notification using fcm.sendEachForMulticast
* Log success/failure
* Return summary

üß™ ACCEPTANCE CRITERIA
* Browser asks notification permission
* Token is generated
* Token saved in DB
* Backend sends push
* Notification appears:
    * When tab is open
    * When tab is closed
    * When PWA is installed

üö´ DO NOT DO (IMPORTANT)
* ‚ùå Do NOT add Android app in Firebase
* ‚ùå Do NOT add iOS app in Firebase
* ‚ùå Do NOT install Capacitor push plugin
* ‚ùå Do NOT remove VAPID logic

üß† RESULT AFTER THIS PROMPT
You will have:
* ‚úÖ Working Web Push notifications
* ‚úÖ Backend-controlled delivery
* ‚úÖ Token infrastructure ready
* ‚úÖ Zero rework later for Capacitor

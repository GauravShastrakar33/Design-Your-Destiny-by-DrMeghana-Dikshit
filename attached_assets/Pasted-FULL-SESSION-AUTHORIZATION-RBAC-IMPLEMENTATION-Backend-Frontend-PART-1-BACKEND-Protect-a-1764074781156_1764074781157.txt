FULL SESSION AUTHORIZATION + RBAC IMPLEMENTATION
(Backend + Frontend)

‚úÖ PART 1 ‚Äî BACKEND: Protect all API routes
‚≠ê 1. Add global backend protection
In server/index.ts, add:

// Protect ALL admin routes (SUPER_ADMIN + COACH)
app.use("/admin/v1", authenticate, (req, res, next) => {
  // @ts-ignore
  if (!["SUPER_ADMIN", "COACH"].includes(req.user.role)) {
    return res.status(403).json({ message: "Admin access required" });
  }
  next();
});

// Protect ALL user routes (USER + COACH allowed)
app.use("/api/v1", authenticate, (req, res, next) => {
  // @ts-ignore
  if (!["USER", "COACH"].includes(req.user.role)) {
    return res.status(403).json({ message: "User access required" });
  }
  next();
});
‚úî Admin API now requires SUPER_ADMIN or COACH
‚úî User API now requires USER or COACH
‚úî No unauthorized access

‚≠ê 2. Add global "last_activity" middleware
Create:
server/middleware/activity.ts

import { db } from "../db";
import { users } from "../db/schema";
import { eq } from "drizzle-orm";

export async function updateLastActivity(req, res, next) {
  try {
    // @ts-ignore
    const userId = req.user?.sub;
    if (userId) {
      await db.update(users)
        .set({ lastActivity: new Date() })
        .where(eq(users.id, userId));
    }
  } catch (e) {
    console.log("lastActivity update failed:", e);
  }
  next();
}
Add to index.ts BELOW authenticate:

import { updateLastActivity } from "./middleware/activity";

app.use(updateLastActivity);
‚úî Every API call updates last activity‚Ä®‚úî Works for all roles

‚úÖ PART 2 ‚Äî FRONTEND: Route Protection (React)
‚≠ê 1. Create Admin Protected Route
Create file:
client/src/components/AdminRoute.tsx

import { Navigate } from "react-router-dom";

export default function AdminRoute({ children }) {
  const token = localStorage.getItem("token");
  const data = localStorage.getItem("admin_user");

  if (!token || !data) return <Navigate to="/admin/login" replace />;

  const user = JSON.parse(data);

  if (!["SUPER_ADMIN", "COACH"].includes(user.role)) {
    return <Navigate to="/admin/login" replace />;
  }

  return children;
}

‚≠ê 2. Create User Protected Route
File:
client/src/components/UserRoute.tsx

import { Navigate } from "react-router-dom";

export default function UserRoute({ children }) {
  const token = localStorage.getItem("user_token");
  const data = localStorage.getItem("user_info");

  if (!token || !data) return <Navigate to="/login" replace />;

  const user = JSON.parse(data);

  if (user.role !== "USER" && user.role !== "COACH") {
    return <Navigate to="/login" replace />;
  }

  return children;
}

‚≠ê 3. Use them in App.tsx routing
Example:

import AdminRoute from "./components/AdminRoute";
import UserRoute from "./components/UserRoute";

<Route
  path="/admin/dashboard"
  element={
    <AdminRoute>
      <AdminDashboard />
    </AdminRoute>
  }
/>

<Route
  path="/home"
  element={
    <UserRoute>
      <UserHome />
    </UserRoute>
  }
/>
‚úî Now admin dashboard requires admin role‚Ä®‚úî User dashboard requires user role

‚úÖ PART 3 ‚Äî Role-Based Redirect After Login
Update admin login page
After successful login:

if (data.user.role === "SUPER_ADMIN") {
    window.location.href = "/admin/dashboard";
} else if (data.user.role === "COACH") {
    window.location.href = "/coach/dashboard";
}
Update user login page
After user login:

window.location.href = "/home";

‚úÖ PART 4 ‚Äî Role-Based UI Hiding
Wherever you show navigation:

const admin = JSON.parse(localStorage.getItem("admin_user") || "null");

{admin?.role === "SUPER_ADMIN" && (
   <AdminOnlyMenuItems />
)}

{admin?.role === "COACH" && (
   <CoachMenuItems />
)}
Similarly for user:

const user = JSON.parse(localStorage.getItem("user_info") || "null");

{user?.role === "USER" && <UserMenu />}
‚úî No wrong user sees admin panel‚Ä®‚úî Admin panel hidden from users‚Ä®‚úî Clear, clean UI separation

‚≠ê After implementing EVERYTHING above:

üîí Backend
‚úî All APIs protected‚Ä®‚úî Role-based access implemented‚Ä®‚úî last_activity auto updated‚Ä®‚úî No unauthorized access to admin‚Ä®‚úî No wrong user accessing admin routes
üîí Frontend
‚úî Admin dashboard protected‚Ä®‚úî User dashboard protected‚Ä®‚úî Role-based redirects‚Ä®‚úî Role-based UI hiding‚Ä®‚úî Session persists‚Ä®‚úî Login always shows first
